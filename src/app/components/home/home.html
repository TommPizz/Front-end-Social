<div class="home-container">
  <div class="top-bar">
    <button class="create-post-btn" (click)="navigateToCreatePost()">â• Crea Post</button>
    <button class="logout-btn" (click)="logout()">Logout</button>
  </div>

  <h1>Feed dei Post</h1>

  <!-- SEZIONE TENDENZE -->
  <div class="tendenze-section">
    <h2>ğŸ”¥ Tendenze</h2>

    <!-- Loading -->
    <div *ngIf="loadingTendenze() && mostraTendenze()"><p>Caricamento tendenze...</p></div>

    <!-- Errore -->
    <div *ngIf="errorTendenze() && mostraTendenze()">
      {{ errorTendenze() }} 
      <button (click)="loadTendenze()">Riprova</button>
    </div>

    <!-- Lista tendenze -->
    <div *ngIf="!loadingTendenze() && !errorTendenze() && mostraTendenze()">
      <div *ngIf="tendenze().length === 0"><p>Nessuna tendenza al momento</p></div>

      <div *ngFor="let post of tendenze(); trackBy: trackByPostId" class="tendenza-card">
        <div class="post-header">
          <span>@{{ post.usernameUtente }}</span>
          <span>{{ formatDate(post.dataOra) }}</span>
        </div>

        <div class="post-content">{{ post.contenuto }}</div>

        <div class="post-footer">
          <button class="like-btn" (click)="toggleLike(post)" [class.liked]="hasLiked(post.id)">â­ {{ post.numeroLike || 0 }}</button>
          <button class="comment-toggle-btn" (click)="toggleCommentiTendenze(post.id)">ğŸ’¬ {{ post.commenti?.length || 0 }}</button>
          <button class="delete-btn" *ngIf="possoEliminarePost(post)" (click)="apriModaleEliminazionePost(post)">ğŸ—‘ï¸ Elimina</button>
        </div>

        <!-- Commenti tendenze -->
        <div *ngIf="sonoCommentiVisibiliTendenze(post.id)" class="comments-section">
          <div class="new-comment-form">
            <textarea [value]="getTestoCommento(post.id)" (input)="aggiornaTestoCommento(post.id, $any($event.target).value)"></textarea>
            <button class="send-comment-btn" (click)="aggiungiCommento(post.id)">Invia</button>
          </div>

          <div *ngIf="post.commenti && post.commenti.length > 0">
            <div *ngFor="let commento of post.commenti; trackBy: trackByCommentId" class="comment">
              <div class="comment-header">
                <span class="comment-author">@{{ commento.utente?.username || 'Utente' }}</span>
                <span class="comment-date">{{ commento.dataOra | date:'short' }}</span>
              </div>
              <p class="comment-text">{{ commento.testo }}</p>

              <!-- Solo autore puÃ² modificare/eliminare commento -->
              <div *ngIf="possoModificareCommento(commento)" class="comment-actions-inline">
                <button class="edit-btn" (click)="iniziaModificaCommento(commento.idCommento, commento.testo)">âœï¸ Modifica</button>
                <button class="delete-btn" (click)="apriModaleEliminazioneCommento(post.id, commento.idCommento)">ğŸ—‘ï¸ Elimina</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEZIONE POST NORMALI -->
  <div class="main-feed-section">
    <h2>Tutti i Post</h2>

    <div *ngIf="loading()"><p>Caricamento post...</p></div>

    <div *ngIf="error()">
      {{ error() }} 
      <button (click)="loadPosts()">Riprova</button>
    </div>

    <div *ngIf="!loading() && !error()">
      <div *ngIf="posts().length === 0"><p>Nessun post disponibile</p></div>

      <div *ngFor="let post of posts(); trackBy: trackByPostId" class="post-card">
        <div class="post-header">
          <span>@{{ post.usernameUtente }}</span>
          <span>{{ formatDate(post.dataOra) }}</span>
        </div>

        <div class="post-content">{{ post.contenuto }}</div>

        <div class="post-footer">
          <button class="like-btn" (click)="toggleLike(post)" [class.liked]="hasLiked(post.id)">â­ {{ post.numeroLike || 0 }}</button>
          <button class="comment-toggle-btn" (click)="toggleCommenti(post.id)">ğŸ’¬ {{ post.commenti?.length || 0 }}</button>
          <button class="delete-btn" *ngIf="possoEliminarePost(post)" (click)="apriModaleEliminazionePost(post)">ğŸ—‘ï¸ Elimina</button>
        </div>

        <!-- Commenti post -->
        <div *ngIf="sonoCommentiVisibili(post.id)" class="comments-section">
          <div class="new-comment-form">
            <textarea [value]="getTestoCommento(post.id)" (input)="aggiornaTestoCommento(post.id, $any($event.target).value)"></textarea>
            <button class="send-comment-btn" (click)="aggiungiCommento(post.id)">Invia</button>
          </div>

          <div *ngIf="post.commenti && post.commenti.length > 0">
            <div *ngFor="let commento of post.commenti; trackBy: trackByCommentId" class="comment">
              <div class="comment-header">
                <span class="comment-author">@{{ commento.utente?.username || 'Utente' }}</span>
                <span class="comment-date">{{ commento.dataOra | date:'short' }}</span>
              </div>
              <p class="comment-text">{{ commento.testo }}</p>

              <div *ngIf="possoModificareCommento(commento)" class="comment-actions-inline">
                <button class="edit-btn" (click)="iniziaModificaCommento(commento.idCommento, commento.testo)">âœï¸ Modifica</button>
                <button class="delete-btn" (click)="apriModaleEliminazioneCommento(post.id, commento.idCommento)">ğŸ—‘ï¸ Elimina</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALE UNIFICATA -->
  <div *ngIf="mostraModaleEliminazione()" class="modal-overlay" (click)="chiudiModaleEliminazione()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Conferma eliminazione</h3>

      <p *ngIf="commentoDaEliminare()">Sei sicuro di voler eliminare questo commento?</p>
      <p *ngIf="postDaEliminare()">Sei sicuro di voler eliminare questo post?</p>

      <button class="btn-cancel" (click)="chiudiModaleEliminazione()">Annulla</button>
      <button class="btn-delete" (click)="confermaEliminazione()">Elimina</button>
    </div>
  </div>
</div>
